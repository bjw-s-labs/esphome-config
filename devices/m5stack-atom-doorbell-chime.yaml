---
# Device: M5Stack Atom Speaker Kit
# Config is based on https://github.com/esphome/media-players/blob/main/m5stack-atom-speaker-kit.yaml
#

packages:
  <<: !include_dir_named ../components/common
  wifi: !include ../components/hardware/wifi.yaml
  board: !include ../boards/m5stack-atom.yaml

substitutions:
  log_baudrate: "115200"

improv_serial:

mqtt:
  on_message:
    - topic: amcrest2mqtt/Z17876DEBF0B6/doorbell
      payload: "on"
      then:
        - script.execute: chime_if_not_muted

globals:
  - id: var_chime_muted
    type: bool
    restore_value: true
    initial_value: "false"

script:
  - id: chime_if_not_muted
    then:
      - if:
          condition:
            switch.is_off: doorbell_chime_muted
          then:
            - media_player.play_media:
                id: media_out
                media_url: 'http://10.1.3.151:8123/local/audio/doorbell.mp3'
            - light.turn_on:
                id: led
                brightness: 50%
                red: 100%
                green: 50%
                blue: 0%
                flash_length:
                  seconds: 10

media_player:
  - platform: i2s_audio
    id: media_out
    name: ${friendly_name}
    dac_type: external
    i2s_lrclk_pin: GPIO21
    i2s_dout_pin: GPIO25
    i2s_bclk_pin: GPIO22
    mode: mono

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO39
      inverted: true
    name: ${friendly_name} Button
    on_click:
      - script.execute: chime_if_not_muted

light:
  - platform: fastled_clockless
    name: ${friendly_name}
    id: led
    pin: GPIO27
    chipset: SK6812
    num_leds: 1
    rgb_order: grb
    on_turn_on:
      then:
        - light.turn_on:
            id: led
            brightness: 30%
            red: 0%
            green: 100%
            blue: 0%

switch:
  - platform: template
    name: "${friendly_name} Muted"
    id: doorbell_chime_muted
    restore_state: false
    turn_on_action:
      - globals.set:
          id: var_chime_muted
          value: "true"
    turn_off_action:
      - globals.set:
          id: var_chime_muted
          value: "false"
    lambda: |-
      return id(var_chime_muted);
